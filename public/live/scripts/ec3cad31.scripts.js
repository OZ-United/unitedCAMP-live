!function(a){"use strict";function b(){this.data={}}function c(){this.listeners=new b}function d(a){setTimeout(function(){throw a},0)}function e(a){this.type=a}function f(a,b){e.call(this,a),this.data=b.data,this.lastEventId=b.lastEventId}function g(a,b){var c=Number(a)||b;return A>c?A:c>18e6?18e6:c}function h(a,b){try{"function"==typeof a&&a(b)}catch(c){d(c)}}function i(b,d){function i(){M=s,null!==J&&(J.abort(),J=null),0!==K&&(clearTimeout(K),K=0),G.readyState=s}function j(a){var b=M===r||M===q?J.responseText||"":"",c=null;if(M===q){var d=n?""!==b?J.getResponseHeader("Content-Type"):"":J.contentType,i=n?""!==b?J.status:0:200;if(200===i&&d&&y.test(d)&&(M=r,I=!0,H=C,G.readyState=r,c=new e("open"),G.dispatchEvent(c),h(G.onopen,c),M===s))return}if(M===r){b.length>L&&(0!==K&&clearTimeout(K),K=setTimeout(Q,A),I=!0);for(var j=L-1,k=b.length;++j<k;){var l=b[j];if(R===t&&"\n"===l)R=u;else if(R===t&&(R=u),"\r"===l||"\n"===l){if("data"===S?N.push(T):"id"===S?O=T:"event"===S?P=T:"retry"===S?(C=g(T,C),H=C,C>D&&(D=C)):"retryLimit"===S?D=g(T,D):"heartbeatTimeout"===S&&(E=g(T,E),0!==K&&(clearTimeout(K),K=setTimeout(Q,E))),T="",S="",R===u){if(0!==N.length&&(F=O,""===P&&(P="message"),c=new f(P,{data:N.join("\n"),lastEventId:O}),G.dispatchEvent(c),"message"===P&&h(G.onmessage,c),M===s))return;N.length=0,P=""}R="\r"===l?t:u}else R===u&&(R=v),R===v?":"===l?R=w:S+=l:R===w?(" "!==l&&(T+=l),R=x):R===x&&(T+=l)}L=k}M!==r&&M!==q||!(a||L>1048576||0===K&&!I)?0===K&&(I=!1,K=setTimeout(Q,E)):(M=p,J.abort(),0!==K&&(clearTimeout(K),K=0),H>D&&(H=D),K=setTimeout(Q,H),H=2*H+1,G.readyState=q,c=new e("error"),G.dispatchEvent(c),h(G.onerror,c))}function k(){j(!1)}function l(){j(!0)}b=String(b);var B=Boolean(m&&d&&d.withCredentials),C=g(d?d.retry:0/0,1e3),D=g(d?d.retryLimit:0/0,3e5),E=g(d?d.heartbeatTimeout:0/0,45e3),F=d&&d.lastEventId&&String(d.lastEventId)||"",G=this,H=C,I=!1,J=new o,K=0,L=0,M=p,N=[],O="",P="",Q=null,R=u,S="",T="";d=null,Q=function(){if(K=0,M!==p)return j(!1),void 0;if(navigator.onLine===!1)return K=setTimeout(Q,500),void 0;if(z&&a.document&&("loading"===a.document.readyState||"interactive"===a.document.readyState))return K=setTimeout(Q,100),void 0;J.onload=J.onerror=l,void 0===J.mozAnon?J.onprogress=k:J.onreadystatechange=k,I=!1,K=setTimeout(Q,E),L=0,M=q,N.length=0,P="",O=F,T="",S="",R=u;var c=b.slice(0,5);c="data:"!==c&&"blob:"!==c?b+((-1===b.indexOf("?",0)?"?":"&")+"lastEventId="+encodeURIComponent(F)+"&r="+String(Math.random()+1).slice(2)):b,J.open("GET",c,!0),J.withCredentials=B,J.responseType="text",n&&J.setRequestHeader("Accept","text/event-stream"),J.send(null)},c.call(this),this.close=i,this.url=b,this.readyState=q,this.withCredentials=B,this.onopen=null,this.onmessage=null,this.onerror=null,Q()}function j(){this.CONNECTING=q,this.OPEN=r,this.CLOSED=s}b.prototype={get:function(a){return this.data[a+"~"]},set:function(a,b){this.data[a+"~"]=b},"delete":function(a){delete this.data[a+"~"]}},c.prototype={dispatchEvent:function(a){var b=String(a.type),c=this.listeners,e=c.get(b);if(e)for(var f=e.length,g=-1,h=null;++g<f;){h=e[g];try{h.call(this,a)}catch(i){d(i)}}},addEventListener:function(a,b){a=String(a);var c=this.listeners,d=c.get(a);d||(d=[],c.set(a,d));for(var e=d.length;--e>=0;)if(d[e]===b)return;d.push(b)},removeEventListener:function(a,b){a=String(a);var c=this.listeners,d=c.get(a);if(d){for(var e=d.length,f=[],g=-1;++g<e;)d[g]!==b&&f.push(d[g]);0===f.length?c["delete"](a):c.set(a,f)}}},f.prototype=e.prototype;var k=a.XMLHttpRequest,l=a.XDomainRequest,m=Boolean(k&&void 0!==(new k).withCredentials),n=m,o=m?k:l,p=-1,q=0,r=1,s=2,t=3,u=4,v=5,w=6,x=7,y=/^text\/event\-stream;?(\s*charset\=utf\-8)?$/i,z=/AppleWebKit\/5([0-2][0-9]|3[0-4])[\.\s\w]/.test(navigator.userAgent),A=80;j.prototype=c.prototype,i.prototype=new j,j.call(i),o&&(a.EventSource=i)}(this),angular.module("liveApp",["ngResource"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl",resolve:{user:["Auth",function(a){var b=a.getUser();return console.log(b),b}]}}).when("/auth",{templateUrl:"views/auth.html",controller:"AuthCtrl"}).when("/user",{templateUrl:"views/user.html",controller:"UserCtrl"}).otherwise({redirectTo:"/"})}]).run(["$rootScope","$location","Auth",function(a,b,c){a.$on("$routeChangeStart",function(a,d){console.log(d.templateUrl),c.isLoggedIn()&&"views/auth.html"==d.templateUrl&&b.path("/")})}]),angular.module("liveApp").controller("MainCtrl",["$scope","Message","Auth","user",function(a,b,c,d){var e=function(){return a.messages&&a.messages.length&&a.messages[a.messages.length-1].date||(new Date).toISOString()};a.from=e(),a.messages=b.query({from:a.from},function(a){console.log(JSON.stringify(a))},function(a){console.log(JSON.stringify(a))}),a.user=d,a.post=function(){a.postForm.$valid&&(a.message.author=a.user.userId,b.create(a.message,function(){console.log("posted")}),a.message={})},a.remove=function(c){var d=a.messages.indexOf(c);return 0>d?!1:(b.remove({messageId:a.messages[d].messageId},function(){a.messages.splice(d,1)}),void 0)},a.loadMore=function(){a.from=e(),b.query({from:a.from},function(b){console.log(b),a.messages=a.messages.concat(b),0===b.length&&(a.nomore=!0)})},a.showNewMessages=function(){a.messages=a.newMessages.concat(a.messages),a.newMessages=[]},a.newMessages=[],window.setTimeout(function(){var b=new EventSource("http://united-camp-live.janantala.com/messages/watch");b.addEventListener("message",function(b){var c=JSON.parse(b.data);a.newMessages.splice(0,0,c),console.log(c),a.$apply()},!1),b.addEventListener("error",function(){},!1)},1e3)}]),angular.module("liveApp").factory("Auth",["$http","$q","$rootScope",function(a,b,c){var d="united-camp-live";return c.rootuser=JSON.parse(localStorage.getItem(d)||"{}"),{login:function(e){var f=b.defer();return a.post("/users/auth",e).success(function(a){c.rootuser=a,localStorage.setItem(d,JSON.stringify(a)),f.resolve(a)}).error(function(a){alert(a.message||"Nepodarilo sa vykonať akciu"),f.reject(a)}),f.promise},update:function(e){var f=b.defer();return a.put("/users/"+e.userId,e).success(function(a){c.rootuser=a,localStorage.setItem(d,JSON.stringify(a)),f.resolve(a)}).error(function(a){alert(a.message||"Nepodarilo sa vykonať akciu"),f.reject(a)}),f.promise},logout:function(){return c.rootuser={},localStorage.setItem(d,JSON.stringify(c.rootuser)),c.rootuser},getUser:function(){return c.rootuser},isLoggedIn:function(){return c.rootuser.login?!0:!1}}}]),angular.module("liveApp").factory("Message",["$resource",function(a){var b=window.location.protocol+"//"+window.location.host;return console.log(b),a("/messages/:messageId",{messageId:"@messageId"},{create:{method:"POST",params:{}},query:{method:"GET",headers:{"X-App-Origin":b},params:{from:"@from"},isArray:!0},update:{method:"PUT",params:{}},remove:{method:"DELETE",params:{}},"delete":{method:"DELETE",params:{}}})}]),angular.module("liveApp").controller("AuthCtrl",["$scope","Auth","$location",function(a,b,c){a.login=function(){a.loginForm.$valid&&b.login(a.user).then(function(a){console.log(a),c.path("/")},function(a){console.log(a)})},a.cancel=function(){c.path("/")}}]),angular.module("liveApp").controller("UserCtrl",["$scope","Auth","$location",function(a,b,c){a.user=JSON.parse(JSON.stringify(b.getUser())),a.user.password="",a.logout=function(){b.logout(),c.path("/")},a.cancel=function(){c.path("/")},a.update=function(){a.loginForm.$valid&&b.update(a.user).then(function(a){console.log(a),c.path("/")},function(a){console.log(a)})}}]);